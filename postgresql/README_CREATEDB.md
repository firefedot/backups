### Создание базы данных

Работают два варианта создания базы.

 - Из дампа тестового или демо сервера ( есть переменная test_db_server )
 - Чиста база из svn ( нет переменной test_db_server )
 
## Запуск

    ansible-playbook playbook_createdb.yml -i ../test2_hosts_sample.yml
    # -i ../test2_hosts_sample.yml - файл инвентори
    #  В зависимости от наличия переменной test_db_server выполнится та или другая схема разворачивания
    #  см. ниже
 
### Создание базы из тестового/демо дампа

 Для получения дампа с тестового нужно в файл инвентори,
 в глобальные переменные прописать две переменные
 
    test_db_server: 192.168.44.153 - адрес тестового или демо сервера 
    test_db_name: sixt_tag - имя базы
 
 Работает со связкой логин/пароль root:root ( как на всех тестовых серверах и демо сервере )
 
 Забирается дамп с сервера и кладется временно в дирректорию **roles/dump_from_test/files/{{ customer }}_backup.bz2**
 
 Затем отправляется на мастер сервер БД и там разворачивается
 
 Среднее время отработки около 7 минут ( На примере базы в 722 строк и весом 38 Мб)
 
 Временный файл **roles/dump_from_test/files/{{ customer }}_backup.bz2** удаляется
 

### Предварительная подготовка

Так как наш svn доступен только из локальной сети, 
то сборку базы, нужно делать на машине, 
которая видит нашу сеть локальную ( своя или вм )

По этому нужно чтобы на своей машине было установлено:

     - posgresql-9.6
     - openjdk-8-jdk-headless
В базе должен быть пользователь **root**  с паролем **root** -  без этого
наш gradlew не будет работать ( Можно уточнить у Леши Пушкина, он может пояснить )

- Можно все это проделать самостоятельно, 
- Можно запустить баш скрипт `install_local_soft.sh`,
- Можно запустить на своей машине плейбук `playbook_install_local_soft.yml` предварительно создав пользователя ansible

После этого запустить плейбук установки базы данных:

    ansible-playbook playbook_createdb.yml -i ../test2_hosts_sample.yml
    # test2_hosts_sample.yml - нужный файл инвенторя
    
### Что делает

На локальной машине подключается к svn,
собирает все файлы, берет имя расширения и тег из файла инвенторя.

Все это кладет в дирректорию `roles/createdb/files/{{ customer }}`

Устанавливает переменные окружения 

    export HAULMONT_REPOSITORY_USER=developer
    export HAULMONT_REPOSITORY_PASSWORD=Haul
    
И собирает/генерирует новую, чистую базу данных на локальной машине

Из-за того, что надо создавать пользователя для postgres root:root, 
не стал создавать базу с помощью gradlew сразу на целевом сервере

Далее снимается дамп, кладется в туже дирреторию `roles/createdb/files/{{ customer }}`
и передается на целевой сервер в дирректорию __local_hosts_

Создается база данных, создаются расширения для заббикса, 
и разворачивается дамп

Добавляется в базу таймзона сервера, на случай общежития

Удаляются временные файлы с локальной машины

Среднее выполнение плейбука 10 минут

### p.s.

pg_restore  вополняется через модуль `shell`,
так как через модуль `postgresql_db`, падает ошибка из-за смены owner'a.
База разворачивается, но ошибка идет, failed_when  посчитал тут не нужным ( пока что )
пока что это не побеждено.

### p.s.2

Данный варинт создания/генерации базы можно использовать для тестовых серверов, когда нужна чистая база


 
